//promise polyfill
import Promise from 'pinkie-promise'
window.Promise = Promise
//fetch polyfill
import 'fetch-detector'
import 'fetch-ie8'

import {
  stringifyQuery,
  stringifyJSON,
  compose,
  merge,
  replace,
  type,
  always,
  ifElse,
  equals,
  props,
  api,
  head
} from '../'

export const get  = (url, data = {}) => fetch(api(`${ url }${ stringifyQuery(data) }`)).then(resp => resp.json())

export const send = (url, data, method = 'post', headers = {}) => {
  if(compose(equals('Object'), type)(method)) {
    headers = method
    method  = 'post'
  }

  headers = merge({ 'Content-Type': 'application/json' }, headers)

  const body = ifElse(
    compose(equals('application/x-www-form-urlencoded'), head, props(['Content-Type'])),
    compose(always, replace('?', ''), stringifyQuery)(data),
    compose(always, stringifyJSON)(data)
  )(headers)

  return fetch(api(url), { method, headers, body }).then(resp => resp.json())
}

export const getText = url => fetch(api(url)).then(resp => resp.text())
